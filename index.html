<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BUYLAA </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
      --border-radius: 12px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fb;
      color: #333;
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
    }
    
    .logo i {
      font-size: 28px;
    }
    
    nav {
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-btn:hover, .nav-btn.active {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .page-title {
      margin: 25px 0;
      color: var(--dark);
      font-size: 28px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title i {
      color: var(--primary);
    }
    
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 24px;
      margin-bottom: 30px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .card-title i {
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      font-size: 16px;
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #e31273;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-success {
      background: #2ecc71;
      color: white;
    }
    
    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    thead {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      color: white;
    }
    
    th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      position: relative;
    }
    
    th i {
      margin-left: 5px;
      font-size: 14px;
    }
    
    tbody tr {
      border-bottom: 1px solid var(--light-gray);
      transition: var(--transition);
    }
    
    tbody tr:last-child {
      border-bottom: none;
    }
    
    tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    td {
      padding: 16px;
      color: var(--dark);
    }
    
    .profit-positive {
      color: #2ecc71;
      font-weight: 600;
    }
    
    .profit-negative {
      color: var(--danger);
      font-weight: 600;
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
    }
    
    .stat-card:nth-child(1)::before { background: var(--primary); }
    .stat-card:nth-child(2)::before { background: #2ecc71; }
    .stat-card:nth-child(3)::before { background: var(--warning); }
    .stat-card:nth-child(4)::before { background: #9b59b6; }
    .stat-card:nth-child(5)::before { background: var(--danger); }
    .stat-card:nth-child(6)::before { background: #3498db; }
    
    .stat-title {
      font-size: 16px;
      color: var(--gray);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--dark);
    }
    
    .stat-positive {
      color: #2ecc71;
    }
    
    .stat-negative {
      color: var(--danger);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      font-size: 20px;
    }
    
    .sales-icon {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }
    
    .profit-icon {
      background: rgba(46, 204, 113, 0.1);
      color: #2ecc71;
    }
    
    .expense-icon {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger);
    }
    
    .orders-icon {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }
    
    .tab {
      padding: 15px 25px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      text-align: center;
      flex: 1;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
      border-bottom: 3px solid var(--secondary);
    }
    
    .tab:hover:not(.active) {
      background: var(--light-gray);
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .month-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }
    
    .month-selector select {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--light-gray);
      font-size: 16px;
    }
    
    .monthly-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .summary-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }
    
    .summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }
    
    .summary-card:nth-child(1)::before { background: var(--primary); }
    .summary-card:nth-child(2)::before { background: var(--danger); }
    .summary-card:nth-child(3)::before { background: var(--warning); }
    .summary-card:nth-child(4)::before { background: #3498db; }
    .summary-card:nth-child(5)::before { background: #9b59b6; }
    .summary-card:nth-child(6)::before { background: #2ecc71; }
    
    .summary-title {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 10px;
    }
    
    .summary-value {
      font-size: 24px;
      font-weight: 700;
    }
    
    .summary-profit {
      color: #2ecc71;
    }
    
    .summary-loss {
      color: var(--danger);
    }
    
    .filter-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--light-gray);
      border-radius: 8px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-group label {
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: var(--border-radius);
      width: 500px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .total-cost-badge {
      background: linear-gradient(120deg, var(--primary), var(--secondary));
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
    }
    
    /* Monthly Analytics Styles */
    .analytics-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .analytics-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 20px;
      transition: var(--transition);
    }
    
    .analytics-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .analytics-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .analytics-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .analytics-trend {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .trend-up {
      color: #2ecc71;
    }
    
    .trend-down {
      color: var(--danger);
    }
    
    .analytics-chart {
      height: 200px;
      margin-top: 15px;
      position: relative;
    }
    
    .chart-bar {
      display: flex;
      align-items: flex-end;
      height: 150px;
      gap: 10px;
      margin-top: 10px;
    }
    
    .chart-column {
      flex: 1;
      background: var(--primary);
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: var(--transition);
    }
    
    .chart-column:hover {
      opacity: 0.8;
    }
    
    .chart-label {
      text-align: center;
      font-size: 12px;
      margin-top: 5px;
      color: var(--gray);
    }
    
    .monthly-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .breakdown-item:last-child {
      border-bottom: none;
    }
    
    @media (max-width: 992px) {
      .form-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .filter-container {
        grid-template-columns: 1fr;
      }
      
      .analytics-container {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      nav {
        width: 100%;
        justify-content: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .actions {
        justify-content: center;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .monthly-summary {
        grid-template-columns: 1fr;
      }
      
      .month-selector {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <span>Buylaa Manager </span>
      </div>
      <nav>
        <a href="#" class="nav-btn active" data-target="orders-section">
          <i class="fas fa-file-invoice-dollar"></i> 
          <span>Orders Management</span>
        </a>
        <a href="#" class="nav-btn" data-target="monthly-section">
          <i class="fas fa-money-bill"></i> 
          <span>Monthly Costs</span>
        </a>
        <a href="#" class="nav-btn" data-target="analytics-section">
          <i class="fas fa-chart-bar"></i> 
          <span>Monthly Analytics</span>
        </a>
      </nav>
    </div>
  </header>

  <div class="container">
    <h1 class="page-title">
      <i class="fas fa-calculator"></i>
      Business Management Dashboard
    </h1>

    <!-- Orders Section -->
    <div id="orders-section" class="content-section active">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-chart-line"></i>
            Total Sales
          </div>
          <div class="stat-value" id="total-sales">RS 0</div>
          <div class="stat-icon sales-icon">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-trending-up"></i>
            Total Profit
          </div>
          <div class="stat-value stat-positive" id="total-profit">RS 0</div>
          <div class="stat-icon profit-icon">
            <i class="fas fa-trending-up"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-shopping-bag"></i>
            Total Orders
          </div>
          <div class="stat-value" id="total-orders">0</div>
          <div class="stat-icon orders-icon">
            <i class="fas fa-shopping-bag"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-percent"></i>
            Avg. Profit Margin
          </div>
          <div class="stat-value stat-positive" id="avg-margin">0%</div>
          <div class="stat-icon expense-icon">
            <i class="fas fa-percent"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-truck"></i>
            Total Delivery Expense
          </div>
          <div class="stat-value" id="total-delivery">RS 0</div>
          <div class="stat-icon expense-icon">
            <i class="fas fa-truck"></i>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-title">
            <i class="fas fa-money-bill-wave"></i>
            Total Cost
          </div>
          <div class="stat-value" id="total-cost">RS 0</div>
          <div class="stat-icon expense-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-plus-circle"></i>
          Add New Order
        </h2>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" class="form-control" placeholder="Enter customer name">
          </div>
          
          <div class="form-group">
            <label for="orderId">Order ID</label>
            <input type="text" id="orderId" class="form-control" placeholder="Enter order ID">
          </div>
          
          <div class="form-group">
            <label for="reference">Reference</label>
            <input type="text" id="reference" class="form-control" placeholder="Enter reference">
          </div>
          
          <div class="form-group">
            <label for="costPrice">Cost Price (RS)</label>
            <input type="number" id="costPrice" class="form-control" placeholder="0.00" step="0.01">
          </div>
          
          <div class="form-group">
            <label for="salePrice">Sale Price (RS)</label>
            <input type="number" id="salePrice" class="form-control" placeholder="0.00" step="0.01">
          </div>
          
          <div class="form-group">
            <label for="orderExpense">Order Expense (RS)</label>
            <input type="number" id="orderExpense" class="form-control" placeholder="0.00" step="0.01">
          </div>
          
          <div class="form-group">
            <label for="deliveryExpense">Delivery Expense (RS)</label>
            <input type="number" id="deliveryExpense" class="form-control" placeholder="0.00" step="0.01">
          </div>
          
          <div class="form-group">
            <label for="orderDate">Order Date</label>
            <input type="date" id="orderDate" class="form-control" value="">
          </div>
        </div>
        
        <div class="actions">
          <button onclick="addOrder()" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Add Order
          </button>
        </div>
      </div>
      
      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-list-alt"></i>
          Order List
        </h2>

        <div class="filter-container">
          <div class="filter-group">
            <label for="filterOrderId">Filter by Order ID</label>
            <input type="text" id="filterOrderId" class="form-control" placeholder="Enter Order ID" oninput="filterOrders()">
          </div>
          
          <div class="filter-group">
            <label for="filterDate">Filter by Date</label>
            <input type="date" id="filterDate" class="form-control" onchange="filterOrders()">
          </div>
          
          <div class="filter-group">
            <label for="filterMonth">Filter by Month</label>
            <input type="month" id="filterMonth" class="form-control" onchange="filterOrders()">
          </div>
          
          <div class="filter-group">
            <label style="opacity: 0;">Reset</label>
            <button onclick="resetFilters()" class="btn btn-primary btn-sm">
              <i class="fas fa-sync"></i>
              Reset Filters
            </button>
          </div>
          
          <div class="filter-group">
            <label style="opacity: 0;">Download</label>
            <button onclick="downloadCSV()" class="btn btn-success btn-sm">
              <i class="fas fa-download"></i>
              Download CSV
            </button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Customer <i class="fas fa-sort"></i></th>
                <th>Order ID <i class="fas fa-sort"></i></th>
                <th>Reference <i class="fas fa-sort"></i></th>
                <th>Cost <i class="fas fa-sort"></i></th>
                <th>Sale <i class="fas fa-sort"></i></th>
                <th>Order Expense <i class="fas fa-sort"></i></th>
                <th>Delivery Expense <i class="fas fa-sort"></i></th>
                <th>Profit <i class="fas fa-sort"></i></th>
                <th>Date <i class="fas fa-sort"></i></th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <!-- Data will be inserted here -->
            </tbody>
          </table>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
          <div class="total-cost-badge">
            <i class="fas fa-calculator"></i>
            Total Cost: <span id="table-total-cost">RS 0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Costs Section -->
    <div id="monthly-section" class="content-section">
      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-money-bill"></i>
          Add Monthly Cost
        </h2>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="costName">Cost Name</label>
            <input type="text" id="costName" class="form-control" placeholder="Enter cost name">
          </div>
          
          <div class="form-group">
            <label for="costCategory">Category</label>
            <select id="costCategory" class="form-control">
              <option value="">Select Category</option>
              <option value="Rent">Rent</option>
              <option value="Utilities">Utilities</option>
              <option value="Salaries">Salaries</option>
              <option value="Marketing">Marketing</option>
              <option value="Supplies">Supplies</option>
              <option value="Delivery">Delivery</option>
              <option value="Ads">Ads</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="costAmount">Amount (RS)</label>
            <input type="number" id="costAmount" class="form-control" placeholder="0.00" step="0.01">
          </div>
          
          <div class="form-group">
            <label for="costMonth">Month</label>
            <input type="month" id="costMonth" class="form-control">
          </div>
          
          <div class="form-group">
            <label for="costDescription">Description</label>
            <textarea id="costDescription" class="form-control" placeholder="Enter cost description" rows="3"></textarea>
          </div>
        </div>
        
        <div class="actions">
          <button onclick="addMonthlyCost()" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Add Cost
          </button>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-list"></i>
          Monthly Costs
        </h2>
        
        <div class="month-selector">
          <label for="viewMonth">View Month:</label>
          <input type="month" id="viewMonth" class="form-control" style="width: auto;">
          <button onclick="loadMonthlyCosts()" class="btn btn-primary btn-sm">
            <i class="fas fa-filter"></i>
            Filter
          </button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Cost Name</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Month</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="monthlyCostsTable">
              <!-- Monthly costs data will be inserted here -->
            </tbody>
          </table>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
          <div class="total-cost-badge">
            <i class="fas fa-calculator"></i>
            Total Monthly Costs: <span id="monthly-total-cost">RS 0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Analytics Section -->
    <div id="analytics-section" class="content-section">
      <div class="card">
        <h2 class="card-title">
          <i class="fas fa-chart-bar"></i>
          Monthly Analytics
        </h2>
        
        <div class="month-selector">
          <label for="analyticsMonth">View Analytics for:</label>
          <input type="month" id="analyticsMonth" class="form-control" style="width: auto;">
          <button onclick="loadMonthlyAnalytics()" class="btn btn-primary btn-sm">
            <i class="fas fa-filter"></i>
            Load Analytics
          </button>
        </div>

        <div class="analytics-container">
          <div class="analytics-card">
            <div class="analytics-header">
              <h3 class="analytics-title">
                <i class="fas fa-chart-line"></i>
                Monthly Sales
              </h3>
              <span class="analytics-trend trend-up" id="sales-trend">
                <i class="fas fa-arrow-up"></i> 12%
              </span>
            </div>
            <div class="analytics-value" id="monthly-sales">RS 0</div>
            <div class="analytics-chart">
              <div class="chart-bar" id="sales-chart">
                <!-- Chart will be generated here -->
              </div>
            </div>
          </div>
          
          <div class="analytics-card">
            <div class="analytics-header">
              <h3 class="analytics-title">
                <i class="fas fa-trophy"></i>
                Monthly Profit
              </h3>
              <span class="analytics-trend trend-up" id="profit-trend">
                <i class="fas fa-arrow-up"></i> 8%
              </span>
            </div>
            <div class="analytics-value" id="monthly-profit">RS 0</div>
            <div class="analytics-chart">
              <div class="chart-bar" id="profit-chart">
                <!-- Chart will be generated here -->
              </div>
            </div>
          </div>
          
          <div class="analytics-card">
            <div class="analytics-header">
              <h3 class="analytics-title">
                <i class="fas fa-shopping-bag"></i>
                Monthly Orders
              </h3>
              <span class="analytics-trend trend-up" id="orders-trend">
                <i class="fas fa-arrow-up"></i> 5%
              </span>
            </div>
            <div class="analytics-value" id="monthly-orders">0</div>
            <div class="analytics-chart">
              <div class="chart-bar" id="orders-chart">
                <!-- Chart will be generated here -->
              </div>
            </div>
          </div>
          
          <div class="analytics-card">
            <div class="analytics-header">
              <h3 class="analytics-title">
                <i class="fas fa-money-bill-wave"></i>
                Monthly Costs
              </h3>
              <span class="analytics-trend trend-down" id="costs-trend">
                <i class="fas fa-arrow-down"></i> 3%
              </span>
            </div>
            <div class="analytics-value" id="monthly-costs">RS 0</div>
            <div class="analytics-chart">
              <div class="chart-bar" id="costs-chart">
                <!-- Chart will be generated here -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h2 class="card-title">
            <i class="fas fa-table"></i>
            Monthly Breakdown
          </h2>
          <div class="monthly-breakdown" id="monthly-breakdown">
            <!-- Breakdown data will be inserted here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Order</h3>
        <button class="close-modal" onclick="closeEditModal()">&times;</button>
      </div>
      
      <input type="hidden" id="editId">
      <div class="form-group">
        <label for="editCustomer">Customer Name</label>
        <input type="text" id="editCustomer" class="form-control" placeholder="Customer Name">
      </div>
      <div class="form-group">
        <label for="editOrderIdField">Order ID</label>
        <input type="text" id="editOrderIdField" class="form-control" placeholder="Order ID">
      </div>
      <div class="form-group">
        <label for="editReference">Reference</label>
        <input type="text" id="editReference" class="form-control" placeholder="Reference">
      </div>
      <div class="form-group">
        <label for="editCost">Cost Price</label>
        <input type="number" id="editCost" class="form-control" placeholder="Cost Price">
      </div>
      <div class="form-group">
        <label for="editSale">Sale Price</label>
        <input type="number" id="editSale" class="form-control" placeholder="Sale Price">
      </div>
      <div class="form-group">
        <label for="editExpense">Order Expense</label>
        <input type="number" id="editExpense" class="form-control" placeholder="Order Expense">
      </div>
      <div class="form-group">
        <label for="editDeliveryExpense">Delivery Expense</label>
        <input type="number" id="editDeliveryExpense" class="form-control" placeholder="Delivery Expense">
      </div>
      <div class="form-group">
        <label for="editDate">Order Date</label>
        <input type="date" id="editDate" class="form-control">
      </div>
      <div style="text-align:right; margin-top:20px;">
        <button class="btn btn-warning" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-success" onclick="updateOrder()">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase initialization
    const supabaseUrl = "https://tvqzkqyqkighoscozkqo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2cXprcXlxa2lnaG9zY296a3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxMTkzMzgsImV4cCI6MjA2OTY5NTMzOH0.3DYpuZmV3-FNXdRXU_pmL8xSIivq0mYc4XipmDtC0es";
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Global variables
    let allOrders = [];
    let monthlyAnalyticsData = [];
    
    // Set current month in date inputs
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    const currentDate = now.toISOString().slice(0, 10);
    document.getElementById('costMonth').value = currentMonth;
    document.getElementById('viewMonth').value = currentMonth;
    document.getElementById('orderDate').value = currentDate;
    document.getElementById('analyticsMonth').value = currentMonth;
    
    // Format currency function
    function formatCurrency(amount) {
      return 'RS ' + parseFloat(amount).toLocaleString('en-IN', {
        maximumFractionDigits: 2,
        minimumFractionDigits: 2
      });
    }
    
    // Tab navigation
    document.querySelectorAll('.nav-btn').forEach(item => {
      item.addEventListener('click', function() {
        const target = this.getAttribute('data-target');
        
        // Update nav buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Update content sections
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        document.getElementById(target).classList.add('active');
        
        // Load data for the active section
        if (target === 'monthly-section') {
          loadMonthlyCosts();
        } else if (target === 'analytics-section') {
          loadMonthlyAnalytics();
        }
      });
    });

    // Orders Functions
    async function addOrder() {
      let customer = document.getElementById("customerName").value;
      let order_id = document.getElementById("orderId").value;
      let reference = document.getElementById("reference").value;
      let cost = parseFloat(document.getElementById("costPrice").value) || 0;
      let sale = parseFloat(document.getElementById("salePrice").value) || 0;
      let expense = parseFloat(document.getElementById("orderExpense").value) || 0;
      let delivery_expense = parseFloat(document.getElementById("deliveryExpense").value) || 0;
      let order_date = document.getElementById("orderDate").value;

      // Validate inputs
      if (!customer || !order_id || !order_date) {
        alert("Please enter at least Customer Name, Order ID and Date");
        return;
      }

      const { data, error } = await client.from("orders").insert([
        { 
          customer_name: customer, 
          order_id, 
          reference, 
          cost_price: cost, 
          sale_price: sale, 
          order_expense: expense, 
          delivery_expense: delivery_expense,
          order_date 
        }
      ]);

      if (error) {
        alert("Error adding order: " + error.message);
      } else {
        // Clear form
        document.getElementById("customerName").value = "";
        document.getElementById("orderId").value = "";
        document.getElementById("reference").value = "";
        document.getElementById("costPrice").value = "";
        document.getElementById("salePrice").value = "";
        document.getElementById("orderExpense").value = "";
        document.getElementById("deliveryExpense").value = "";
        document.getElementById("orderDate").value = currentDate;
        
        renderOrdersTable();
        updateOrderStats();
      }
    }

    async function deleteOrder(id) {
      if (confirm("Are you sure you want to delete this order?")) {
        const { error } = await client.from("orders").delete().eq("id", id);
        if (error) alert("Error deleting: " + error.message);
        renderOrdersTable();
        updateOrderStats();
      }
    }

    function openEditModal(order) {
      document.getElementById('editId').value = order.id;
      document.getElementById('editCustomer').value = order.customer_name || '';
      document.getElementById('editOrderIdField').value = order.order_id || '';
      document.getElementById('editReference').value = order.reference || '';
      document.getElementById('editCost').value = order.cost_price || 0;
      document.getElementById('editSale').value = order.sale_price || 0;
      document.getElementById('editExpense').value = order.order_expense || 0;
      document.getElementById('editDeliveryExpense').value = order.delivery_expense || 0;
      document.getElementById('editDate').value = order.order_date || '';

      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    async function updateOrder() {
      const id = document.getElementById('editId').value;
      const customer = document.getElementById('editCustomer').value;
      const order_id = document.getElementById('editOrderIdField').value;
      const reference = document.getElementById('editReference').value;
      const cost_price = parseFloat(document.getElementById('editCost').value) || 0;
      const sale_price = parseFloat(document.getElementById('editSale').value) || 0;
      const order_expense = parseFloat(document.getElementById('editExpense').value) || 0;
      const delivery_expense = parseFloat(document.getElementById('editDeliveryExpense').value) || 0;
      const order_date = document.getElementById('editDate').value;

      if (!customer || !order_id || !order_date) {
        alert("Please enter at least Customer Name, Order ID and Date");
        return;
      }

      const { error } = await client
        .from('orders')
        .update({
          customer_name: customer,
          order_id: order_id,
          reference: reference,
          cost_price: cost_price,
          sale_price: sale_price,
          order_expense: order_expense,
          delivery_expense: delivery_expense,
          order_date: order_date
        })
        .eq('id', id);

      if (error) {
        alert("Error updating order: " + error.message);
      } else {
        closeEditModal();
        renderOrdersTable();
        updateOrderStats();
      }
    }

    async function renderOrdersTable() {
      let tbody = document.getElementById("ordersTable");
      tbody.innerHTML = "<tr><td colspan='10' style='text-align: center; padding: 20px;'>Loading orders...</td></tr>";

      const { data: orders, error } = await client.from("orders").select("*").order("order_date", { ascending: false });

      if (error) {
        tbody.innerHTML = "<tr><td colspan='10' style='text-align: center; padding: 20px; color: var(--danger);'>Error loading orders: " + error.message + "</td></tr>";
        return;
      }

      if (orders.length === 0) {
        tbody.innerHTML = "<tr><td colspan='10' style='text-align: center; padding: 20px;'>No orders found. Add your first order above.</td></tr>";
        return;
      }

      // Store all orders for filtering
      allOrders = orders;
      
      // Apply filters if any
      applyFilters();
    }

    function filterOrders() {
      applyFilters();
    }

    function resetFilters() {
      document.getElementById('filterOrderId').value = '';
      document.getElementById('filterDate').value = '';
      document.getElementById('filterMonth').value = '';
      applyFilters();
    }

    function applyFilters() {
      const orderIdFilter = document.getElementById('filterOrderId').value.toLowerCase();
      const dateFilter = document.getElementById('filterDate').value;
      const monthFilter = document.getElementById('filterMonth').value;
      
      let filteredOrders = allOrders;
      
      // Apply Order ID filter
      if (orderIdFilter) {
        filteredOrders = filteredOrders.filter(order => 
          order.order_id && order.order_id.toLowerCase().includes(orderIdFilter)
        );
      }
      
      // Apply date filter
      if (dateFilter) {
        filteredOrders = filteredOrders.filter(order => 
          order.order_date === dateFilter
        );
      }
      
      // Apply month filter
      if (monthFilter) {
        filteredOrders = filteredOrders.filter(order => 
          order.order_date && order.order_date.startsWith(monthFilter)
        );
      }
      
      // Render the filtered orders
      renderOrdersToTable(filteredOrders);
    }

    function renderOrdersToTable(orders) {
      const tbody = document.getElementById("ordersTable");
      
      if (orders.length === 0) {
        tbody.innerHTML = "<tr><td colspan='10' style='text-align: center; padding: 20px;'>No orders match your filters.</td></tr>";
        return;
      }
      
      // Calculate total cost for the table
      let tableTotalCost = 0;
      
      tbody.innerHTML = orders.map(order => {
        const profit = (order.sale_price || 0) - (order.cost_price || 0) - (order.order_expense || 0) - (order.delivery_expense || 0);
        const profitClass = profit >= 0 ? "profit-positive" : "profit-negative";
        
        // Add to total cost
        const orderTotalCost = (order.cost_price || 0) + (order.order_expense || 0) + (order.delivery_expense || 0);
        tableTotalCost += orderTotalCost;
        
        return `
          <tr>
            <td>${order.customer_name || "-"}</td>
            <td>${order.order_id || "-"}</td>
            <td>${order.reference || "-"}</td>
            <td>${formatCurrency(order.cost_price || 0)}</td>
            <td>${formatCurrency(order.sale_price || 0)}</td>
            <td>${formatCurrency(order.order_expense || 0)}</td>
            <td>${formatCurrency(order.delivery_expense || 0)}</td>
            <td class="${profitClass}">${formatCurrency(profit)}</td>
            <td>${formatDate(order.order_date)}</td>
            <td class="action-cell">
              <button onclick="openEditModal(${JSON.stringify(order).replace(/"/g, '&quot;')})" class="btn btn-warning btn-sm">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteOrder(${order.id})" class="btn btn-danger btn-sm">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join("");
      
      // Update the total cost badge
      document.getElementById("table-total-cost").textContent = formatCurrency(tableTotalCost);
    }

    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleDateString();
    }

    async function updateOrderStats() {
      const { data: orders, error } = await client.from("orders").select("*");
      
      if (error || !orders) {
        console.error("Error fetching orders for stats:", error);
        return;
      }
      
      let totalSales = 0;
      let totalCost = 0;
      let totalOrderExpense = 0;
      let totalDeliveryExpense = 0;
      let totalProfit = 0;
      
      orders.forEach(order => {
        totalSales += order.sale_price || 0;
        totalCost += order.cost_price || 0;
        totalOrderExpense += order.order_expense || 0;
        totalDeliveryExpense += order.delivery_expense || 0;
        totalProfit += (order.sale_price || 0) - (order.cost_price || 0) - (order.order_expense || 0) - (order.delivery_expense || 0);
      });
      
      const totalOverallCost = totalCost + totalOrderExpense + totalDeliveryExpense;
      const avgMargin = totalSales > 0 ? ((totalProfit / totalSales) * 100) : 0;
      
      document.getElementById("total-sales").textContent = formatCurrency(totalSales);
      document.getElementById("total-profit").textContent = formatCurrency(totalProfit);
      document.getElementById("total-orders").textContent = orders.length;
      document.getElementById("avg-margin").textContent = `${avgMargin.toFixed(2)}%`;
      document.getElementById("total-delivery").textContent = formatCurrency(totalDeliveryExpense);
      document.getElementById("total-cost").textContent = formatCurrency(totalOverallCost);
    }

    // Monthly Costs Functions
    async function addMonthlyCost() {
      const name = document.getElementById("costName").value;
      const category = document.getElementById("costCategory").value;
      const amount = parseFloat(document.getElementById("costAmount").value) || 0;
      const month = document.getElementById("costMonth").value;
      const description = document.getElementById("costDescription").value;

      if (!name || !category || !month) {
        alert("Please enter Cost Name, Category, and Month");
        return;
      }

      const { data, error } = await client.from("monthly_costs").insert([
        { name, category, amount, month, description }
      ]);

      if (error) {
        alert("Error adding monthly cost: " + error.message);
      } else {
        // Clear form
        document.getElementById("costName").value = "";
        document.getElementById("costCategory").value = "";
        document.getElementById("costAmount").value = "";
        document.getElementById("costMonth").value = currentMonth;
        document.getElementById("costDescription").value = "";
        
        loadMonthlyCosts();
      }
    }

    async function deleteMonthlyCost(id) {
      if (confirm("Are you sure you want to delete this monthly cost?")) {
        const { error } = await client.from("monthly_costs").delete().eq("id", id);
        if (error) alert("Error deleting: " + error.message);
        loadMonthlyCosts();
      }
    }

    async function loadMonthlyCosts() {
      const monthFilter = document.getElementById("viewMonth").value;
      let query = client.from("monthly_costs").select("*");
      
      if (monthFilter) {
        query = query.eq("month", monthFilter);
      }
      
      const { data: costs, error } = await query.order("month", { ascending: false });
      
      const tbody = document.getElementById("monthlyCostsTable");
      
      if (error) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align: center; padding: 20px; color: var(--danger);'>Error loading costs: " + error.message + "</td></tr>";
        return;
      }
      
      if (costs.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align: center; padding: 20px;'>No monthly costs found for the selected month.</td></tr>";
        return;
      }
      
      // Calculate total monthly costs
      let totalMonthlyCosts = 0;
      
      tbody.innerHTML = costs.map(cost => {
        totalMonthlyCosts += cost.amount || 0;
        
        return `
          <tr>
            <td>${cost.name}</td>
            <td>${cost.category}</td>
            <td>${formatCurrency(cost.amount)}</td>
            <td>${formatMonth(cost.month)}</td>
            <td>${cost.description || "-"}</td>
            <td class="action-cell">
              <button onclick="deleteMonthlyCost(${cost.id})" class="btn btn-danger btn-sm">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join("");
      
      // Update the total monthly costs badge
      document.getElementById("monthly-total-cost").textContent = formatCurrency(totalMonthlyCosts);
    }

    function formatMonth(monthString) {
      if (!monthString) return "-";
      const date = new Date(monthString + "-01");
      return date.toLocaleDateString("en-US", { year: "numeric", month: "long" });
    }

    // Monthly Analytics Functions
    async function loadMonthlyAnalytics() {
      const monthFilter = document.getElementById("analyticsMonth").value;
      
      // Get orders for the selected month
      const { data: orders, error: ordersError } = await client
        .from("orders")
        .select("*")
        .gte("order_date", `${monthFilter}-01`)
        .lt("order_date", getNextMonth(monthFilter));
      
      // Get monthly costs for the selected month
      const { data: costs, error: costsError } = await client
        .from("monthly_costs")
        .select("*")
        .eq("month", monthFilter);
      
      if (ordersError || costsError) {
        alert("Error loading analytics data");
        return;
      }
      
      // Calculate monthly analytics
      let monthlySales = 0;
      let monthlyCosts = 0;
      let monthlyProfit = 0;
      let monthlyOrders = orders.length;
      
      orders.forEach(order => {
        monthlySales += order.sale_price || 0;
        monthlyCosts += (order.cost_price || 0) + (order.order_expense || 0) + (order.delivery_expense || 0);
        monthlyProfit += (order.sale_price || 0) - (order.cost_price || 0) - (order.order_expense || 0) - (order.delivery_expense || 0);
      });
      
      // Add monthly fixed costs
      costs.forEach(cost => {
        monthlyCosts += cost.amount || 0;
      });
      
      // Update analytics cards
      document.getElementById("monthly-sales").textContent = formatCurrency(monthlySales);
      document.getElementById("monthly-profit").textContent = formatCurrency(monthlyProfit);
      document.getElementById("monthly-orders").textContent = monthlyOrders;
      document.getElementById("monthly-costs").textContent = formatCurrency(monthlyCosts);
      
      // Load historical data for charts
      await loadHistoricalData(monthFilter);
      
      // Update breakdown
      updateMonthlyBreakdown(orders, costs);
    }
    
    async function loadHistoricalData(currentMonth) {
      // Get last 6 months of data
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const date = new Date(currentMonth + '-01');
        date.setMonth(date.getMonth() - i);
        months.push(date.toISOString().slice(0, 7));
      }
      
      const historicalData = [];
      
      for (const month of months) {
        // Get orders for the month
        const { data: orders } = await client
          .from("orders")
          .select("*")
          .gte("order_date", `${month}-01`)
          .lt("order_date", getNextMonth(month));
        
        // Get monthly costs for the month
        const { data: costs } = await client
          .from("monthly_costs")
          .select("*")
          .eq("month", month);
        
        let sales = 0;
        let profit = 0;
        let ordersCount = orders ? orders.length : 0;
        let costsTotal = 0;
        
        if (orders) {
          orders.forEach(order => {
            sales += order.sale_price || 0;
            profit += (order.sale_price || 0) - (order.cost_price || 0) - (order.order_expense || 0) - (order.delivery_expense || 0);
            costsTotal += (order.cost_price || 0) + (order.order_expense || 0) + (order.delivery_expense || 0);
          });
        }
        
        if (costs) {
          costs.forEach(cost => {
            costsTotal += cost.amount || 0;
          });
        }
        
        historicalData.push({
          month,
          sales,
          profit,
          orders: ordersCount,
          costs: costsTotal
        });
      }
      
      monthlyAnalyticsData = historicalData;
      renderCharts();
    }
    
    function renderCharts() {
      // Sales chart
      const salesChart = document.getElementById('sales-chart');
      salesChart.innerHTML = '';
      
      const maxSales = Math.max(...monthlyAnalyticsData.map(d => d.sales));
      
      monthlyAnalyticsData.forEach(data => {
        const height = maxSales > 0 ? (data.sales / maxSales) * 100 : 0;
        const monthName = new Date(data.month + '-01').toLocaleDateString('en-US', { month: 'short' });
        
        salesChart.innerHTML += `
          <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
            <div class="chart-column" style="height: ${height}%; background: var(--primary);"></div>
            <div class="chart-label">${monthName}</div>
          </div>
        `;
      });
      
      // Profit chart
      const profitChart = document.getElementById('profit-chart');
      profitChart.innerHTML = '';
      
      const maxProfit = Math.max(...monthlyAnalyticsData.map(d => Math.abs(d.profit)));
      
      monthlyAnalyticsData.forEach(data => {
        const height = maxProfit > 0 ? (Math.abs(data.profit) / maxProfit) * 100 : 0;
        const monthName = new Date(data.month + '-01').toLocaleDateString('en-US', { month: 'short' });
        const color = data.profit >= 0 ? '#2ecc71' : '#f72585';
        
        profitChart.innerHTML += `
          <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
            <div class="chart-column" style="height: ${height}%; background: ${color};"></div>
            <div class="chart-label">${monthName}</div>
          </div>
        `;
      });
      
      // Orders chart
      const ordersChart = document.getElementById('orders-chart');
      ordersChart.innerHTML = '';
      
      const maxOrders = Math.max(...monthlyAnalyticsData.map(d => d.orders));
      
      monthlyAnalyticsData.forEach(data => {
        const height = maxOrders > 0 ? (data.orders / maxOrders) * 100 : 0;
        const monthName = new Date(data.month + '-01').toLocaleDateString('en-US', { month: 'short' });
        
        ordersChart.innerHTML += `
          <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
            <div class="chart-column" style="height: ${height}%; background: var(--warning);"></div>
            <div class="chart-label">${monthName}</div>
          </div>
        `;
      });
      
      // Costs chart
      const costsChart = document.getElementById('costs-chart');
      costsChart.innerHTML = '';
      
      const maxCosts = Math.max(...monthlyAnalyticsData.map(d => d.costs));
      
      monthlyAnalyticsData.forEach(data => {
        const height = maxCosts > 0 ? (data.costs / maxCosts) * 100 : 0;
        const monthName = new Date(data.month + '-01').toLocaleDateString('en-US', { month: 'short' });
        
        costsChart.innerHTML += `
          <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
            <div class="chart-column" style="height: ${height}%; background: var(--danger);"></div>
            <div class="chart-label">${monthName}</div>
          </div>
        `;
      });
    }
    
    function updateMonthlyBreakdown(orders, costs) {
      const breakdownContainer = document.getElementById('monthly-breakdown');
      
      // Calculate breakdown by category
      const categoryBreakdown = {};
      
      // Order-related categories
      categoryBreakdown['Product Costs'] = orders.reduce((sum, order) => sum + (order.cost_price || 0), 0);
      categoryBreakdown['Order Expenses'] = orders.reduce((sum, order) => sum + (order.order_expense || 0), 0);
      categoryBreakdown['Delivery Expenses'] = orders.reduce((sum, order) => sum + (order.delivery_expense || 0), 0);
      
      // Monthly cost categories
      costs.forEach(cost => {
        if (!categoryBreakdown[cost.category]) {
          categoryBreakdown[cost.category] = 0;
        }
        categoryBreakdown[cost.category] += cost.amount || 0;
      });
      
      // Create breakdown items
      let breakdownHTML = '';
      
      for (const [category, amount] of Object.entries(categoryBreakdown)) {
        if (amount > 0) {
          breakdownHTML += `
            <div class="breakdown-item">
              <span>${category}</span>
              <span>${formatCurrency(amount)}</span>
            </div>
          `;
        }
      }
      
      breakdownContainer.innerHTML = breakdownHTML;
    }
    
    function getNextMonth(month) {
      const date = new Date(month + '-01');
      date.setMonth(date.getMonth() + 1);
      return date.toISOString().slice(0, 10);
    }

    // CSV Download Function
    function downloadCSV() {
      // Get filtered orders
      const orderIdFilter = document.getElementById('filterOrderId').value.toLowerCase();
      const dateFilter = document.getElementById('filterDate').value;
      const monthFilter = document.getElementById('filterMonth').value;
      
      let filteredOrders = allOrders;
      
      // Apply Order ID filter
      if (orderIdFilter) {
        filteredOrders = filteredOrders.filter(order => 
          order.order_id && order.order_id.toLowerCase().includes(orderIdFilter)
        );
      }
      
      // Apply date filter
      if (dateFilter) {
        filteredOrders = filteredOrders.filter(order => 
          order.order_date === dateFilter
        );
      }
      
      // Apply month filter
      if (monthFilter) {
        filteredOrders = filteredOrders.filter(order => 
          order.order_date && order.order_date.startsWith(monthFilter)
        );
      }
      
      if (filteredOrders.length === 0) {
        alert("No orders to download");
        return;
      }
      
      // Create CSV content
      let csvContent = "Customer Name,Order ID,Reference,Cost Price,Sale Price,Order Expense,Delivery Expense,Profit,Date\n";
      
      filteredOrders.forEach(order => {
        const profit = (order.sale_price || 0) - (order.cost_price || 0) - (order.order_expense || 0) - (order.delivery_expense || 0);
        
        csvContent += `"${order.customer_name || ''}",`;
        csvContent += `"${order.order_id || ''}",`;
        csvContent += `"${order.reference || ''}",`;
        csvContent += `${order.cost_price || 0},`;
        csvContent += `${order.sale_price || 0},`;
        csvContent += `${order.order_expense || 0},`;
        csvContent += `${order.delivery_expense || 0},`;
        csvContent += `${profit},`;
        csvContent += `${order.order_date || ''}\n`;
      });
      
      // Create download link
      const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      
      // Create filename with current date
      const today = new Date().toISOString().slice(0, 10);
      link.setAttribute("download", `orders_${today}.csv`);
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      renderOrdersTable();
      updateOrderStats();
      loadMonthlyCosts();
      loadMonthlyAnalytics();
      
      // Close modal if clicked outside
      window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
          closeEditModal();
        }
      };
    });
  </script>
</body>
</html>
